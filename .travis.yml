jobs:
  include:
   - os: linux
     arch: amd64
#    - os: linux
#      arch: arm64
sudo: true

addons:
  apt:
    sources:
    - sourceline: 'deb http://us.archive.ubuntu.com/ubuntu/ bionic main restricted universe multiverse'
    packages:
    - shellcheck

services:
  - docker

before_install:
- if [ "${TRAVIS_CPU_ARCH}" == "arm64" ]; then
      arch='arm64' ;
  else
      arch='amd64';
  fi
- curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
- sudo add-apt-repository 'deb [arch=$(arch)] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable'
- sudo apt-get update
- sudo apt-get -y install docker-ce
- sudo docker build -t gluster/client ./gluster-client/
- sudo docker run --name client gluster/client rpm -qa | grep gluster
- sudo docker build -t gluster/centos ./CentOS/
- sudo docker run -d --name gcentos --privileged gluster/centos
- sleep 10
- sudo docker exec gcentos systemctl is-active glusterd
- sudo docker stop gcentos
- sudo docker rm gcentos
- sudo mkdir -p /home/centos-glusterd
- sudo mkdir -p /home/centos-gluster-etc
- sudo mkdir -p /home/centos-gluster-log
- sudo docker run --name gcentos -v /home/centos-glusterd:/var/lib/glusterd/:z -v /home/centos-gluster-etc:/etc/glusterfs:z -v /home/centos-gluster-log:/var/log/glusterfs --privileged gluster/centos
- sleep 10
- sudo docker exec gcentos systemctl is-active glusterd
- sudo docker stop gcentos
- sudo docker rm gcentos
- sudo docker build -t gluster/fedora ./Fedora/
- sudo docker run --name gfedora --privileged -v /sys/fs/cgroup:/sys/fs/cgroup:ro gluster/fedora
- sleep 10
- sudo docker exec gfedora systemctl is-active glusterd
- sudo docker stop gfedora
- sudo docker rm gfedora
- sudo mkdir -p /home/fedora-glusterd
- sudo mkdir -p /home/fedora-gluster-etc
- sudo mkdir -p /home/fedora-gluster-log
- sudo docker run --name gfedora -v /home/fedora-glusterd:/var/lib/glusterd/:z -v /home/fedora-gluster-etc:/etc/glusterfs:z -v /home/fedora-gluster-log:/var/log/glusterfs -v /sys/fs/cgroup:/sys/fs/cgroup:ro --privileged gluster/fedora
- sleep 10
- sudo docker exec gfedora systemctl is-active glusterd
- sudo docker stop gfedora
- sudo docker rm gfedora
- sudo docker build -t gluster/s3object ./gluster-s3object/CentOS/docker-gluster-s3/
- sudo docker run --name s3object --privileged -v /sys/fs/cgroup:/sys/fs/cgroup:ro -e S3_ACCOUNT=vol -e S3_USER="admin" -e S3_PASSWORD="redhat" gluster/s3object
- sleep 10
- sudo docker exec s3object systemctl is-active swift-object

script:
- make test
